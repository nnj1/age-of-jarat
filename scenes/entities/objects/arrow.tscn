[gd_scene format=3 uid="uid://bfu1iccj67rot"]

[ext_resource type="Script" uid="uid://dk26clul6uf2m" path="res://src/arrow.gd" id="1_3sgs4"]
[ext_resource type="Texture2D" uid="uid://fik2xyspevag" path="res://assets/tilesets/urizen_onebit_tileset__v2d0.png" id="3_f8n3w"]
[ext_resource type="AudioStream" uid="uid://c7krfqadttu4b" path="res://assets/sfx/Minifantasy_Dungeon_SFX/20_orc_special_atk.wav" id="4_f8n3w"]

[sub_resource type="Shader" id="Shader_24gab"]
code = "shader_type canvas_item;

varying vec2 local_uv; 

// --- Bounce & Deformation ---
uniform float random_phase;
uniform float speed : hint_range(0.1, 10.0) = 5.0;
uniform float height : hint_range(0.0, 100.0) = 0.0;
uniform float squash_amount : hint_range(0.0, 0.5) = 0.024;
uniform float sprite_height = 12.0;

// --- Transparency Logic ---
uniform float threshold : hint_range(0.0, 1.0) = 0.1;
uniform float edge_distance : hint_range(0.0, 1.0) = 0.055;

// --- Border Controls ---
uniform bool use_active_state = false;
uniform vec4 default_border_color : source_color = vec4(0.0, 0.0, 0.0, 1.0);
uniform vec4 active_border_color : source_color = vec4(1.0, 0.0, 0.0, 1.0);
uniform float default_border_width : hint_range(0.0, 10.0) = 0.5;
uniform float active_border_width : hint_range(0.0, 10.0) = 0.25;

float get_shape_alpha(sampler2D tex, vec2 uv, vec2 l_uv) {
    vec4 tex_color = texture(tex, uv);
    float dist = distance(l_uv, vec2(0.5, 0.5));
    float brightness = (tex_color.r + tex_color.g + tex_color.b) / 3.0;
    
    if (brightness < threshold && dist > edge_distance) {
        return 0.0;
    }
    return tex_color.a;
}

void vertex() {
    local_uv = UV;
    
    float time = (TIME + random_phase) * speed;
    float bounce_cycle = abs(sin(time)); 
    float squash_cycle = cos(time * 2.0); 
    
    float squash_factor = 1.0 + (squash_cycle * squash_amount);
    VERTEX.x *= (1.0 + (squash_cycle * -squash_amount));
    VERTEX.y *= squash_factor;

    float center_to_bottom = sprite_height / 2.0;
    float correction = (center_to_bottom * squash_factor) - center_to_bottom;
    VERTEX.y -= correction;
    VERTEX.y -= bounce_cycle * height;
}

void fragment() {
    vec4 color = texture(TEXTURE, UV);
    float current_a = get_shape_alpha(TEXTURE, UV, local_uv);
    color.a = current_a;

    // Determine color AND width based on the active state
    vec4 final_border_color = use_active_state ? active_border_color : default_border_color;
    float final_width = use_active_state ? active_border_width : default_border_width;

    // Border Logic
    if (final_border_color.a > 0.0 && current_a <= 0.0) {
        vec2 size = TEXTURE_PIXEL_SIZE * final_width;
        
        float neighbor_a = 0.0;
        neighbor_a += get_shape_alpha(TEXTURE, UV + vec2(0.0, -size.y), local_uv + vec2(0.0, -size.y));
        neighbor_a += get_shape_alpha(TEXTURE, UV + vec2(0.0, size.y), local_uv + vec2(0.0, size.y));
        neighbor_a += get_shape_alpha(TEXTURE, UV + vec2(-size.x, 0.0), local_uv + vec2(-size.x, 0.0));
        neighbor_a += get_shape_alpha(TEXTURE, UV + vec2(size.x, 0.0), local_uv + vec2(size.x, 0.0));
        
        if (neighbor_a > 0.0) {
            color = final_border_color;
        }
    }

    COLOR = color;
}"

[sub_resource type="ShaderMaterial" id="ShaderMaterial_f8n3w"]
shader = SubResource("Shader_24gab")
shader_parameter/random_phase = 0.0
shader_parameter/speed = 0.10000000149012
shader_parameter/height = 0.0
shader_parameter/squash_amount = 0.024
shader_parameter/sprite_height = 12.0
shader_parameter/threshold = 0.1
shader_parameter/edge_distance = 0.4
shader_parameter/use_active_state = false
shader_parameter/default_border_color = Color(0, 0, 0, 1)
shader_parameter/active_border_color = Color(1, 0, 0, 1)
shader_parameter/default_border_width = 0.5
shader_parameter/active_border_width = 0.25

[sub_resource type="AtlasTexture" id="AtlasTexture_g0f7c"]
atlas = ExtResource("3_f8n3w")
region = Rect2(430, 131, 12, 12)

[sub_resource type="CircleShape2D" id="CircleShape2D_24gab"]
radius = 2.828427

[sub_resource type="ParticleProcessMaterial" id="ParticleProcessMaterial_24gab"]
particle_flag_disable_z = true
emission_shape = 1
emission_sphere_radius = 5.0
direction = Vector3(-1, 0, 0)
spread = 5.0
gravity = Vector3(0, 0, 0)

[sub_resource type="SceneReplicationConfig" id="SceneReplicationConfig_24gab"]
properties/0/path = NodePath("PoisonGPUParticles2D:emitting")
properties/0/spawn = true
properties/0/replication_mode = 2
properties/1/path = NodePath("PoisonGPUParticles2D:visible")
properties/1/spawn = true
properties/1/replication_mode = 2
properties/2/path = NodePath(".:speed")
properties/2/spawn = true
properties/2/replication_mode = 1
properties/3/path = NodePath(".:direction")
properties/3/spawn = true
properties/3/replication_mode = 1
properties/4/path = NodePath(".:rotation")
properties/4/spawn = true
properties/4/replication_mode = 1
properties/5/path = NodePath(".:position")
properties/5/spawn = true
properties/5/replication_mode = 1

[node name="Arrow" type="Area2D" unique_id=1718636598]
collision_layer = 0
collision_mask = 3
script = ExtResource("1_3sgs4")

[node name="Sprite2D" type="Sprite2D" parent="." unique_id=167961135]
material = SubResource("ShaderMaterial_f8n3w")
rotation = 0.7853982
scale = Vector2(0.99999994, 0.99999994)
texture = SubResource("AtlasTexture_g0f7c")

[node name="CollisionShape2D" type="CollisionShape2D" parent="." unique_id=1107174817]
position = Vector2(5, 0)
shape = SubResource("CircleShape2D_24gab")

[node name="AudioStreamPlayer2D" type="AudioStreamPlayer2D" parent="." unique_id=1973172680]
stream = ExtResource("4_f8n3w")
autoplay = true
bus = &"Sfx"

[node name="PoisonGPUParticles2D" type="GPUParticles2D" parent="." unique_id=339624519]
modulate = Color(0.5897365, 0.00025441914, 0.5897323, 1)
position = Vector2(-4, 1)
amount = 100
lifetime = 0.5
randomness = 1.0
process_material = SubResource("ParticleProcessMaterial_24gab")

[node name="MultiplayerSynchronizer" type="MultiplayerSynchronizer" parent="." unique_id=1072848856]
replication_config = SubResource("SceneReplicationConfig_24gab")

[connection signal="body_entered" from="." to="." method="_on_body_entered"]
